<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý Thiết Kế V3 - Tích hợp AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Be+Vietnam+Pro:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --mau-nen: #FDF8E1;
            --mau-chu-dam: #422006;
            --mau-nau-dam: #8C5A2B;
            --mau-vang-cam: #D97706;
        }
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: var(--mau-nen);
            color: var(--mau-chu-dam);
        }
        .font-display { font-family: 'Playfair Display', serif; }
        
        .control-panel-section {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .layout-selector input:checked + label {
            border-color: var(--mau-vang-cam);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.4);
            background-color: #FFFBEB;
        }
        .layout-preview-box {
            aspect-ratio: 1 / 1;
            border: 2px dashed #D1C4A8;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .layout-preview-box > div {
            background-color: #D1C4A8; border-radius: 4px; color: white;
            font-size: 0.6rem; padding: 2px 4px; text-align: center;
        }
        .layout-preview-box .logo-placeholder { background-color: #A5B4FC; width: 20%; padding: 4px 0; }
        .layout-preview-box .note-placeholder { background-color: #F87171; width: 40%; }
        .layout-preview-box .text-placeholder { background-color: #60A5FA; width: 80%; padding: 8px 0; }

        #mobile-toolbar { transition: transform 0.3s ease-in-out; }
        .mobile-panel {
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.4s;
            visibility: hidden;
        }
        .mobile-panel.is-open { transform: translateY(0); visibility: visible; }
        #mobile-toolbar button.active { color: var(--mau-vang-cam); background-color: #FFFBEB; }

        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details .accordion-icon { transition: transform 0.3s ease; }
        details[open] .accordion-icon { transform: rotate(90deg); }

        .loader { 
            border: 5px solid #D1C4A8; border-top: 5px solid #8C5A2B;
            border-radius: 50%; width: 50px; height: 50px; 
            animation: spin 1.5s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body class="overflow-x-hidden">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Image Display Area -->
        <div id="image-panel" class="w-full lg:w-2/3 bg-gray-200 flex items-center justify-center p-4 lg:p-8 relative">
            <div id="canvas-container" class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-2xl">
                <canvas id="resultCanvas" class="w-full h-auto rounded-lg"></canvas>
            </div>
            <!-- Loading Indicator -->
            <div id="loading-overlay" class="absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center z-20 hidden">
                <div class="loader"></div>
                <p class="text-white font-semibold mt-4">Đang tạo ảnh nền, vui lòng chờ...</p>
            </div>
        </div>

        <!-- Desktop Controls -->
        <div id="controls-panel" class="hidden lg:block w-full lg:w-1/3 bg-white border-l-4 border-yellow-100 p-8 space-y-6 overflow-y-auto">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-amber-800 font-display">Trợ Lý Thiết Kế V3</h1>
                <p class="text-amber-600 mt-1">Tạo ảnh AI & Tùy chỉnh nâng cao.</p>
            </header>
            <div id="desktop-controls-content"></div>
             <a id="downloadBtn" href="#" download="thiep-anh-phat-giao.png" class="mt-6 w-full text-center bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-4 rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                Tải Về Hình Ảnh
            </a>
        </div>
    </div>

    <!-- Mobile UI -->
    <div class="lg:hidden">
        <div id="panels-container" class="fixed inset-0 bg-black bg-opacity-30 z-40" style="visibility: hidden;"></div>
        
        <div id="image-gen-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50">
            <h3 class="font-bold text-lg mb-4 text-center">Bước 1: Tạo Ảnh Nền</h3>
            <section id="image-gen-controls"></section>
        </div>
        <div id="layout-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50">
            <h3 class="font-bold text-lg mb-4 text-center">Bước 2: Chọn Bố Cục</h3>
            <section id="layout-controls"></section>
        </div>
        <div id="text-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50">
             <h3 class="font-bold text-lg mb-4 text-center">Bước 3: Nhập Nội Dung</h3>
            <section id="text-controls"></section>
        </div>
        <div id="style-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50 overflow-y-auto" style="max-height: 80vh;">
             <h3 class="font-bold text-lg mb-4 text-center">Bước 4: Tùy Chỉnh Font</h3>
            <section id="style-controls" class="space-y-4"></section>
        </div>

        <!-- Mobile Toolbar -->
        <div id="mobile-toolbar" class="fixed bottom-0 left-0 right-0 bg-white h-20 border-t shadow-lg flex justify-around items-center z-50">
            <button data-panel="image-gen-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span class="text-xs mt-1">Ảnh Nền</span>
            </button>
            <button data-panel="layout-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                <span class="text-xs mt-1">Bố Cục</span>
            </button>
            <button data-panel="text-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                <span class="text-xs mt-1">Nội Dung</span>
            </button>
            <button data-panel="style-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                <span class="text-xs mt-1">Kiểu Chữ</span>
            </button>
        </div>
    </div>
    
    <!-- Templates for cloning -->
    <div id="templates" class="hidden">
        <div id="template-image-gen-controls">
            <h2 class="text-xl font-bold text-amber-900 mb-3">Bước 1: Tạo Ảnh Nền</h2>
            <div class="space-y-4">
                <p class="text-sm text-amber-700">Bấm nút dưới đây để tạo một ảnh nền ngẫu nhiên theo chủ đề hoa sen Phật giáo.</p>
                <button id="generate-random-image-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M5.523 13.523a8 8 0 0111.954-2.553M20 20v-5h-5M18.477 10.477a8 8 0 01-11.954 2.553" /></svg>
                    Tạo Ảnh Nền Ngẫu Nhiên
                </button>
            </div>
        </div>
        <div id="template-layout-controls">
            <h2 class="text-xl font-bold text-amber-900 mb-3">Bước 2: Bố Cục & Logo</h2>
            <div class="grid grid-cols-3 gap-3 layout-selector" id="layout-selector"></div>
            <div class="mt-4">
                <label for="logo-size" class="block text-sm font-medium text-amber-800">Kích thước Logo: <span id="logo-size-value">15</span>%</label>
                <input type="range" id="logo-size" min="5" max="40" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
        <div id="template-text-controls">
            <h2 class="text-xl font-bold text-amber-900 mb-3">Bước 3: Nhập Nội Dung</h2>
            <div class="space-y-4">
                <div>
                    <label for="text1" class="block text-sm font-medium text-amber-800">Nội dung chính</label>
                    <textarea id="text1" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500"></textarea>
                </div>
                <div>
                    <label for="text3" class="block text-sm font-medium text-amber-800">Ghi chú (Nguồn, ngày tháng...)</label>
                    <input type="text" id="text3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500">
                </div>
            </div>
        </div>
        <div id="template-style-controls">
             <h2 class="text-xl font-bold text-amber-900 mb-3">Bước 4: Tùy Chỉnh Font</h2>
             <details class="bg-amber-50 rounded-lg border border-amber-200 p-4 transition" open>
                <summary class="flex justify-between items-center font-semibold text-amber-900">Văn Bản Chính</summary>
                <div class="mt-4 space-y-5">
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Font chữ</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="main-font-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Màu Sắc</label>
                        <div class="grid grid-cols-5 gap-2 choice-selector mt-3" id="main-color-selector"></div>
                    </div>
                </div>
            </details>
            <details class="bg-amber-50 rounded-lg border border-amber-200 p-4 transition">
                <summary class="flex justify-between items-center font-semibold text-amber-900">Ghi Chú</summary>
                 <div class="mt-4 space-y-5">
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Font chữ</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="note-font-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Màu Sắc</label>
                        <div class="grid grid-cols-5 gap-2 choice-selector mt-3" id="note-color-selector"></div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script type="module">
        // --- STATE & CONFIGURATION ---
        const state = {
            mainText: "Lời hay ý đẹp từ kinh sách, mang lại sự an lạc và trí tuệ.",
            noteText: "Nguồn: Lời Phật Dạy",
            layout: 'layout1',
            main: { font: 'Playfair Display', color: '#FFFFFF', size: 50 },
            note: { font: 'Roboto', color: '#FFFFFF', size: 20 },
            logo: { size: 15 }
        };

        const layouts = {
            layout1: { name: 'Cổ Điển', main: { v: 'top', h: 'center' }, logo: { v: 'bottom', h: 'left' }, note: { v: 'bottom', h: 'right' } },
            layout2: { name: 'Hiện Đại', main: { v: 'center', h: 'center' }, logo: { v: 'top', h: 'left' }, note: { v: 'bottom', h: 'right' } },
            layout3: { name: 'Phá Cách', main: { v: 'bottom', h: 'center' }, logo: { v: 'top', h: 'right' }, note: { v: 'top', h: 'left' } }
        };

        const fontProfiles = [ 'Roboto', 'Be Vietnam Pro', 'Playfair Display', 'Times New Roman', 'Arial' ];
        const colorProfiles = [ '#FFFFFF', '#422006', '#FFFBEB', '#FBBF24', '#F59E0B', '#9A3412', '#D1C4A8', '#FEF3C7', '#1C1917', '#57534E' ];

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        const logoImage = new Image();
        const backgroundImage = new Image();
        let isLogoLoaded = false;
        let areFontsLoaded = false;

        // --- INITIALIZATION ---
        function init() {
            cloneControls();
            setupEventListeners();
            loadInitialAssets();
            generateUIComponents();
            updateAllInputs();
            handleImageGeneration(); // Load an initial random image on startup
        }
        
        function cloneControls() {
            const desktopContainer = document.getElementById('desktop-controls-content');
            const containers = {
                'image-gen-controls': document.getElementById('template-image-gen-controls'),
                'layout-controls': document.getElementById('template-layout-controls'),
                'text-controls': document.getElementById('template-text-controls'),
                'style-controls': document.getElementById('template-style-controls'),
            };

            for (const key in containers) {
                // Mobile
                document.getElementById(key).appendChild(containers[key].cloneNode(true));
                // Desktop
                desktopContainer.appendChild(containers[key]);
            }
        }

        async function loadInitialAssets() {
            const fontChecks = fontProfiles.map(font => document.fonts.load(`700 12px "${font}"`));
            const logoPromise = new Promise(resolve => {
                logoImage.src = 'logo.png';
                logoImage.onload = () => { isLogoLoaded = true; resolve(); };
                logoImage.onerror = () => { console.warn("logo.png not found."); isLogoLoaded = false; resolve(); };
            });
            
            await Promise.all([...fontChecks, logoPromise]);
            areFontsLoaded = true;
            console.log("Fonts and logo loaded.");
            redrawCanvas();
        }
        
        function setBackgroundImage(src) {
            backgroundImage.crossOrigin = "anonymous";
            backgroundImage.src = src;
            backgroundImage.onload = () => {
                canvas.width = backgroundImage.width;
                canvas.height = backgroundImage.height;
                redrawCanvas();
                loadingOverlay.style.display = 'none';
            };
            backgroundImage.onerror = () => {
                alert("Lỗi khi tải ảnh nền.");
                loadingOverlay.style.display = 'none';
            };
        }

        function generateUIComponents() {
            const layoutContainer = document.getElementById('layout-selector');
            for (const key in layouts) {
                const layout = layouts[key];
                layoutContainer.innerHTML += `
                    <div>
                        <input type="radio" name="layout" id="${key}" value="${key}" class="hidden">
                        <label for="${key}" class="block cursor-pointer border-2 border-transparent rounded-lg p-2 text-center transition hover:border-yellow-500">
                            <div class="layout-preview-box">${generateLayoutPreview(layout)}</div>
                            <span class="text-sm font-semibold mt-2 block">${layout.name}</span>
                        </label>
                    </div>`;
            }

            const createSelector = (containerId, items, name, stateKey, stateSubKey) => {
                const containers = document.querySelectorAll(`#${containerId}`);
                let content = '';
                items.forEach((item, index) => {
                    const id = `${name}-${index}`;
                    content += `
                        <div>
                            <input type="radio" name="${name}" id="${id}" value="${item}" class="hidden">
                            <label for="${id}" class="block cursor-pointer border-2 border-amber-200 rounded-lg p-2 text-center transition hover:border-yellow-500 h-full" style="${containerId.includes('color') ? `background-color:${item}` : `font-family:'${item}'`}">
                                ${containerId.includes('color') ? '&nbsp;' : item}
                            </label>
                        </div>`;
                });
                containers.forEach(c => c.innerHTML = content);
            };
            
            createSelector('main-font-selector', fontProfiles, 'main-font', 'main', 'font');
            createSelector('note-font-selector', fontProfiles, 'note-font', 'note', 'font');
            createSelector('main-color-selector', colorProfiles, 'main-color', 'main', 'color');
            createSelector('note-color-selector', colorProfiles, 'note-color', 'note', 'color');
        }

        function generateLayoutPreview(layout) {
            const positions = { top: '', center: '', bottom: ''};
            const addElement = (type) => `<div class="${type}-placeholder">${type.charAt(0).toUpperCase()}</div>`;
            positions[layout.main.v] += addElement('text');
            positions[layout.logo.v] += addElement('logo');
            positions[layout.note.v] += addElement('note');
            return `<div class="flex justify-around w-full">${positions.top}</div><div class="flex justify-around w-full">${positions.center}</div><div class="flex justify-around w-full">${positions.bottom}</div>`;
        }
        
        function updateAllInputs() {
            document.querySelectorAll('#text1').forEach(el => el.value = state.mainText);
            document.querySelectorAll('#text3').forEach(el => el.value = state.noteText);
            document.querySelectorAll(`input[name="layout"][value="${state.layout}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="main-font"][value="${state.main.font}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="note-font"][value="${state.note.font}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="main-color"][value="${state.main.color}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="note-color"][value="${state.note.color}"]`).forEach(el => el.checked = true);
            document.querySelectorAll('#logo-size').forEach(el => el.value = state.logo.size);
            document.querySelectorAll('#logo-size-value').forEach(el => el.textContent = state.logo.size);
        }

        // --- EVENT HANDLING ---
        function setupEventListeners() {
            document.body.addEventListener('input', handleInput);
            document.body.addEventListener('change', handleInput);
            document.body.addEventListener('click', (e) => {
                // Find the closest button with the ID, works with event delegation
                if (e.target.closest('#generate-random-image-btn')) {
                    handleImageGeneration();
                }
            });

            // Mobile panel controls
            const mobileToolBtns = document.querySelectorAll('.mobile-tool-btn');
            const panelsContainer = document.getElementById('panels-container');
            mobileToolBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const panelId = btn.dataset.panel;
                    const panel = document.getElementById(panelId);
                    const isOpen = panel.classList.contains('is-open');
                    closeAllPanels();
                    if (!isOpen) {
                        panel.classList.add('is-open');
                        panelsContainer.style.visibility = 'visible';
                        btn.classList.add('active');
                    }
                });
            });
            panelsContainer.addEventListener('click', closeAllPanels);
            
            downloadBtn.addEventListener('click', () => {
                downloadBtn.href = canvas.toDataURL('image/png');
            });
        }
        
        function handleInput(e) {
            const target = e.target;
            const name = target.name;
            const value = target.value;
            
            if (target.id === 'text1') state.mainText = value;
            if (target.id === 'text3') state.noteText = value;
            if (target.id === 'logo-size') {
                state.logo.size = value;
                document.querySelectorAll('#logo-size-value').forEach(el => el.textContent = value);
            }
            if (name === 'layout') state.layout = value;
            if (name === 'main-font') state.main.font = value;
            if (name === 'note-font') state.note.font = value;
            if (name === 'main-color') state.main.color = value;
            if (name === 'note-color') state.note.color = value;
            
            redrawCanvas();
        }

        function closeAllPanels() {
            document.querySelectorAll('.mobile-panel.is-open').forEach(p => p.classList.remove('is-open'));
            document.querySelectorAll('.mobile-tool-btn.active').forEach(b => b.classList.remove('active'));
            document.getElementById('panels-container').style.visibility = 'hidden';
        }
        
        // --- IMAGE GENERATION ---
        function generateLotusPrompt() {
            const base = "masterpiece, best quality, beautiful anime style illustration of a lotus flower, scenic, soft lighting, clean lines, square image, buddhist theme, serene, spiritual";
            const styles = ["on a serene pond at sunrise with mist", "in a mystical zen garden with cinematic light", "minimalist, clean lines, vibrant gold and brown colors", "with a traditional asian temple in the background fog", "glowing softly in a dark, peaceful environment"];
            return `${base}, ${styles[Math.floor(Math.random() * styles.length)]}`;
        }

        async function queryStabilityAPI(prompt) {
            // This function calls your own server, which then calls Stability AI
            const response = await fetch(`/api/generate-image`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt }),
            });

            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(`Lỗi từ máy chủ: ${errorResult.error || 'Không rõ lỗi'}`);
            }

            const responseJSON = await response.json();
            if (!responseJSON.artifacts || responseJSON.artifacts.length === 0) {
                 throw new Error('Không nhận được ảnh từ API.');
            }
            const imageBase64 = responseJSON.artifacts[0].base64;
            return `data:image/png;base64,${imageBase64}`;
        }

        async function handleImageGeneration() {
            loadingOverlay.style.display = 'flex';
            try {
                const prompt = generateLotusPrompt();
                console.log("Generated Prompt:", prompt);
                const imageUrl = await queryStabilityAPI(prompt);
                setBackgroundImage(imageUrl);
            } catch (error) {
                console.error("Image generation failed:", error);
                alert("Tạo ảnh thất bại: " + error.message);
                loadingOverlay.style.display = 'none';
            }
        }

        // --- DRAWING ENGINE ---
        function redrawCanvas() {
            if (!backgroundImage.complete || !areFontsLoaded) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            const currentLayout = layouts[state.layout];
            if (isLogoLoaded) drawLogo(currentLayout.logo);
            if (state.mainText.trim()) drawText(state.mainText, state.main, currentLayout.main);
            if (state.noteText.trim()) drawText(state.noteText, state.note, currentLayout.note);
        }
        
        function drawLogo(position) {
            const logoSize = canvas.width * (state.logo.size / 100);
            const margin = canvas.width * 0.04;
            const pos = getXY(position, margin, logoSize, logoSize);
            ctx.drawImage(logoImage, pos.x, pos.y, logoSize, logoSize);
        }

        function drawText(text, style, position) {
            const fontSize = canvas.width * (style.size / 1000);
            const margin = canvas.width * 0.04;
            const maxWidth = canvas.width - (margin * 2);
            
            ctx.font = `bold ${fontSize}px "${style.font}"`;
            ctx.fillStyle = style.color;
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            const lines = wrapText(ctx, text, maxWidth);
            const lineHeight = fontSize * 1.3;
            const textBlockHeight = lines.length * lineHeight;
            const pos = getXY(position, margin, maxWidth, textBlockHeight);

            ctx.textAlign = pos.textAlign;
            lines.forEach((line, index) => ctx.fillText(line, pos.x, pos.y + (index * lineHeight)));
            ctx.shadowColor = 'transparent';
        }

        function getXY(position, margin, blockWidth, blockHeight) {
            let x, y, textAlign;
            switch(position.h) {
                case 'left': x = margin; textAlign = 'left'; break;
                case 'right': x = canvas.width - margin; textAlign = 'right'; break;
                default: x = canvas.width / 2; textAlign = 'center';
            }
            switch(position.v) {
                case 'top': y = margin; break;
                case 'bottom': y = canvas.height - margin - blockHeight; break;
                default: y = (canvas.height / 2) - (blockHeight / 2);
            }
            if (position.v !== 'bottom') {
                 y += (ctx.measureText('M').width * 1.2);
            }
            return { x, y, textAlign };
        }

        function wrapText(ctx, text, maxWidth) {
            const finalLines = [];
            text.split('\n').forEach(p => {
                let currentLine = '';
                const words = p.split(' ');
                if (words.length > 0) {
                    currentLine = words[0];
                    for (let i = 1; i < words.length; i++) {
                        if (ctx.measureText(currentLine + " " + words[i]).width < maxWidth) {
                            currentLine += " " + words[i];
                        } else {
                            finalLines.push(currentLine);
                            currentLine = words[i];
                        }
                    }
                }
                finalLines.push(currentLine);
            });
            return finalLines;
        }

        init();
    </script>
</body>
</html>
