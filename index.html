<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý Thiết Kế V2 - Hoằng Pháp Lợi Sanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Be+Vietnam+Pro:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --mau-nen: #FDF8E1;
            --mau-chu-dam: #422006;
            --mau-nau-dam: #8C5A2B;
            --mau-vang-cam: #D97706;
        }
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: var(--mau-nen);
            color: var(--mau-chu-dam);
        }
        .font-display { font-family: 'Playfair Display', serif; }
        
        /* --- General Component Styling --- */
        .control-panel-section {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* --- Layout Template Selector --- */
        .layout-selector input:checked + label {
            border-color: var(--mau-vang-cam);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.4);
            background-color: #FFFBEB;
        }
        .layout-preview-box {
            aspect-ratio: 1 / 1;
            border: 2px dashed #D1C4A8;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .layout-preview-box > div {
            background-color: #D1C4A8;
            border-radius: 4px;
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            text-align: center;
        }
        .layout-preview-box .logo-placeholder {
            background-color: #A5B4FC;
            width: 20%;
            padding: 4px 0;
        }
        .layout-preview-box .note-placeholder {
            background-color: #F87171;
            width: 40%;
        }
        .layout-preview-box .text-placeholder {
            background-color: #60A5FA;
            width: 80%;
            padding: 8px 0;
        }

        /* --- Mobile Toolbar & Panels --- */
        #mobile-toolbar {
            transition: transform 0.3s ease-in-out;
        }
        .mobile-panel {
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.4s;
            visibility: hidden;
        }
        .mobile-panel.is-open {
            transform: translateY(0);
            visibility: visible;
        }
        #mobile-toolbar button.active {
            color: var(--mau-vang-cam);
            background-color: #FFFBEB;
        }

        /* --- Accordion Styling --- */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details .accordion-icon { transition: transform 0.3s ease; }
        details[open] .accordion-icon { transform: rotate(90deg); }

    </style>
</head>
<body class="overflow-x-hidden">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Left/Main Panel: Image Display Area -->
        <div id="image-panel" class="w-full lg:w-2/3 bg-gray-200 flex items-center justify-center p-4 lg:p-8">
            <div id="canvas-container" class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-2xl">
                <canvas id="resultCanvas" class="w-full h-auto rounded-lg"></canvas>
            </div>
        </div>

        <!-- Right Panel: Desktop Controls -->
        <div id="controls-panel" class="hidden lg:block w-full lg:w-1/3 bg-white border-l-4 border-yellow-100 p-8 space-y-6 overflow-y-auto">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-amber-800 font-display">Trợ Lý Thiết Kế V2</h1>
                <p class="text-amber-600 mt-1">Giao diện mới, trải nghiệm mới.</p>
            </header>
            
            <div id="desktop-controls-content">
                <!-- Content will be cloned here from mobile panels -->
            </div>
             <a id="downloadBtn" href="#" download="thiep-anh-phat-giao.png" class="mt-6 w-full text-center bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-4 rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                Tải Về Hình Ảnh
            </a>
        </div>
    </div>

    <!-- Mobile UI Elements -->
    <div class="lg:hidden">
        <!-- Mobile Panels (Slide-up menus) -->
        <div id="panels-container" class="fixed inset-0 bg-black bg-opacity-30 z-40" style="visibility: hidden;"></div>

        <div id="layout-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50">
            <h3 class="font-bold text-lg mb-4 text-center">Chọn Bố Cục</h3>
            <section id="layout-controls" class="control-panel-section bg-amber-50">
                <!-- Layout content will be injected here -->
            </section>
        </div>

        <div id="text-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50">
             <h3 class="font-bold text-lg mb-4 text-center">Nhập Nội Dung</h3>
            <section id="text-controls" class="control-panel-section bg-amber-50">
                <!-- Text content will be injected here -->
            </section>
        </div>

        <div id="style-panel" class="mobile-panel fixed bottom-0 left-0 right-0 bg-white p-5 rounded-t-2xl shadow-2xl z-50 overflow-y-auto" style="max-height: 80vh;">
             <h3 class="font-bold text-lg mb-4 text-center">Tùy Chỉnh Font &amp; Màu</h3>
            <section id="style-controls" class="space-y-4">
                <!-- Style content will be injected here -->
            </section>
        </div>

        <!-- Mobile Toolbar -->
        <div id="mobile-toolbar" class="fixed bottom-0 left-0 right-0 bg-white h-20 border-t shadow-lg flex justify-around items-center z-50">
            <button data-panel="layout-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                <span class="text-xs mt-1">Bố Cục</span>
            </button>
            <button data-panel="text-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                <span class="text-xs mt-1">Nội Dung</span>
            </button>
            <button data-panel="style-panel" class="mobile-tool-btn flex flex-col items-center justify-center text-gray-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                <span class="text-xs mt-1">Kiểu Chữ</span>
            </button>
        </div>
    </div>
    
    <!-- Templates for cloning -->
    <div id="templates" class="hidden">
         <div id="template-layout-controls">
            <h2 class="text-xl font-bold text-amber-900 mb-3">Chọn Bố Cục</h2>
            <div class="grid grid-cols-3 gap-3 layout-selector" id="layout-selector">
                <!-- Layout options will be generated here -->
            </div>
        </div>
        <div id="template-text-controls">
            <h2 class="text-xl font-bold text-amber-900 mb-3">Nhập Nội Dung</h2>
            <div class="space-y-4">
                <div>
                    <label for="text1" class="block text-sm font-medium text-amber-800">Nội dung chính</label>
                    <textarea id="text1" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500" placeholder="Đây là phần nội dung Sư Huynh muốn chèn lên hình ảnh..."></textarea>
                </div>
                <div>
                    <label for="text3" class="block text-sm font-medium text-amber-800">Ghi chú (Nguồn, ngày tháng...)</label>
                    <input type="text" id="text3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500" placeholder="Ví dụ: Lời Phật Dạy, Wenda...">
                </div>
            </div>
        </div>
        <div id="template-style-controls">
             <h2 class="text-xl font-bold text-amber-900 mb-3">Tùy Chỉnh</h2>
             <details class="bg-amber-50 rounded-lg border border-amber-200 p-4 transition" open>
                <summary class="flex justify-between items-center font-semibold text-amber-900">
                    Văn Bản Chính
                    <svg class="w-5 h-5 accordion-icon text-amber-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </summary>
                <div class="mt-4 space-y-5">
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Font chữ</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="main-font-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Màu Sắc</label>
                        <div class="grid grid-cols-5 gap-2 choice-selector mt-3" id="main-color-selector"></div>
                    </div>
                </div>
            </details>
            <details class="bg-amber-50 rounded-lg border border-amber-200 p-4 transition">
                <summary class="flex justify-between items-center font-semibold text-amber-900">
                    Ghi Chú
                    <svg class="w-5 h-5 accordion-icon text-amber-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </summary>
                 <div class="mt-4 space-y-5">
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Font chữ</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="note-font-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm text-amber-800">Màu Sắc</label>
                        <div class="grid grid-cols-5 gap-2 choice-selector mt-3" id="note-color-selector"></div>
                    </div>
                </div>
            </details>
        </div>
    </div>


    <script type="module">
        // --- STATE & CONFIGURATION ---
        const state = {
            mainText: "Lời hay ý đẹp từ kinh sách, mang lại sự an lạc và trí tuệ.",
            noteText: "Nguồn: Lời Phật Dạy",
            layout: 'layout1',
            main: {
                font: 'Playfair Display',
                color: '#FFFFFF',
                size: 50, // Relative size
            },
            note: {
                font: 'Roboto',
                color: '#FFFFFF',
                size: 20, // Relative size
            },
            logo: {
                size: 15, // Percentage of canvas width
            }
        };

        const layouts = {
            layout1: {
                name: 'Cổ Điển',
                main: { v: 'top', h: 'center' },
                logo: { v: 'bottom', h: 'left' },
                note: { v: 'bottom', h: 'right' },
            },
            layout2: {
                name: 'Hiện Đại',
                main: { v: 'center', h: 'center' },
                logo: { v: 'top', h: 'left' },
                note: { v: 'bottom', h: 'right' },
            },
            layout3: {
                name: 'Phá Cách',
                main: { v: 'bottom', h: 'center' },
                logo: { v: 'top', h: 'right' },
                note: { v: 'top', h: 'left' },
            }
        };

        const fontProfiles = [ 'Roboto', 'Be Vietnam Pro', 'Playfair Display', 'Times New Roman', 'Arial' ];
        const colorProfiles = [ '#FFFFFF', '#422006', '#FFFBEB', '#FBBF24', '#F59E0B', '#9A3412', '#D1C4A8', '#FEF3C7', '#1C1917', '#57534E' ];

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const downloadBtn = document.getElementById('downloadBtn');
        
        const logoImage = new Image();
        const backgroundImage = new Image();
        let isLogoLoaded = false;
        let areFontsLoaded = false;

        // --- INITIALIZATION ---
        function init() {
            cloneControls();
            setupEventListeners();
            loadAssets();
            generateUIComponents();
            updateAllInputs();
        }
        
        function cloneControls() {
            const desktopContainer = document.getElementById('desktop-controls-content');
            const mobileLayoutContainer = document.getElementById('layout-controls');
            const mobileTextContainer = document.getElementById('text-controls');
            const mobileStyleContainer = document.getElementById('style-controls');

            const layoutContent = document.getElementById('template-layout-controls').cloneNode(true);
            const textContent = document.getElementById('template-text-controls').cloneNode(true);
            const styleContent = document.getElementById('template-style-controls').cloneNode(true);

            // For mobile
            mobileLayoutContainer.appendChild(layoutContent.cloneNode(true));
            mobileTextContainer.appendChild(textContent.cloneNode(true));
            mobileStyleContainer.appendChild(styleContent.cloneNode(true));
            
            // For desktop
            desktopContainer.appendChild(layoutContent);
            desktopContainer.appendChild(textContent);
            desktopContainer.appendChild(styleContent);
        }

        async function loadAssets() {
            // Load fonts
            try {
                const fontChecks = fontProfiles.map(font => document.fonts.load(`700 12px "${font}"`));
                await Promise.all(fontChecks);
                console.log("Fonts loaded");
                areFontsLoaded = true;
            } catch (err) {
                console.error("Font loading error:", err);
            }

            // Load logo
            logoImage.src = 'logo.png'; // Make sure logo.png is in the same folder
            logoImage.onload = () => {
                console.log("Logo loaded");
                isLogoLoaded = true;
                redrawCanvas();
            };
            logoImage.onerror = () => {
                console.warn("logo.png not found. The logo will not be displayed.");
                isLogoLoaded = false;
                redrawCanvas();
            };

            // Load background
            backgroundImage.crossOrigin = "anonymous";
            backgroundImage.src = 'https://placehold.co/1024x1024/8C5A2B/FDF8E1?text=Nen+Anh';
            backgroundImage.onload = () => {
                console.log("Background loaded");
                canvas.width = backgroundImage.width;
                canvas.height = backgroundImage.height;
                redrawCanvas();
            };
            backgroundImage.onerror = () => {
                console.error("Could not load background image.");
                // Draw a fallback background
                canvas.width = 1024;
                canvas.height = 1024;
                ctx.fillStyle = '#FDF8E1';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#422006';
                ctx.textAlign = 'center';
                ctx.fillText("Lỗi tải ảnh nền", canvas.width / 2, canvas.height / 2);
            };
        }

        function generateUIComponents() {
            // Layout Selector
            const layoutContainer = document.getElementById('layout-selector');
            for (const key in layouts) {
                const layout = layouts[key];
                const checked = key === state.layout ? 'checked' : '';
                layoutContainer.innerHTML += `
                    <div>
                        <input type="radio" name="layout" id="${key}" value="${key}" class="hidden" ${checked}>
                        <label for="${key}" class="block cursor-pointer border-2 border-transparent rounded-lg p-2 text-center transition hover:border-yellow-500">
                            <div class="layout-preview-box">
                                ${generateLayoutPreview(layout)}
                            </div>
                            <span class="text-sm font-semibold mt-2 block">${layout.name}</span>
                        </label>
                    </div>
                `;
            }

            // Font & Color Selectors
            const createSelector = (containerId, items, name, stateKey, stateSubKey) => {
                const container = document.querySelectorAll(`#${containerId}`);
                let content = '';
                items.forEach((item, index) => {
                    const isChecked = item === state[stateKey][stateSubKey];
                    const id = `${name}-${index}`;
                    content += `
                        <div>
                            <input type="radio" name="${name}" id="${id}" value="${item}" class="hidden" ${isChecked ? 'checked' : ''}>
                            <label for="${id}" class="block cursor-pointer border-2 border-amber-200 rounded-lg p-2 text-center transition hover:border-yellow-500 h-full" style="${containerId.includes('color') ? `background-color:${item}` : `font-family:'${item}'`}">
                                ${containerId.includes('color') ? '&nbsp;' : item}
                            </label>
                        </div>`;
                });
                container.forEach(c => c.innerHTML = content);
            };
            
            createSelector('main-font-selector', fontProfiles, 'main-font', 'main', 'font');
            createSelector('note-font-selector', fontProfiles, 'note-font', 'note', 'font');
            createSelector('main-color-selector', colorProfiles, 'main-color', 'main', 'color');
            createSelector('note-color-selector', colorProfiles, 'note-color', 'note', 'color');
        }

        function generateLayoutPreview(layout) {
            const positions = { top: '', center: '', bottom: ''};
            const addElement = (pos, type) => `<div class="${type}-placeholder">${type.charAt(0).toUpperCase()}</div>`;

            positions[layout.main.v] += addElement(layout.main.v, 'text');
            positions[layout.logo.v] += addElement(layout.logo.v, 'logo');
            positions[layout.note.v] += addElement(layout.note.v, 'note');
            
            return `
                <div class="flex justify-around w-full">${positions.top}</div>
                <div class="flex justify-around w-full">${positions.center}</div>
                <div class="flex justify-around w-full">${positions.bottom}</div>
            `;
        }
        
        function updateAllInputs() {
            document.querySelectorAll('#text1').forEach(el => el.value = state.mainText);
            document.querySelectorAll('#text3').forEach(el => el.value = state.noteText);
            document.querySelectorAll(`input[name="layout"][value="${state.layout}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="main-font"][value="${state.main.font}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="note-font"][value="${state.note.font}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="main-color"][value="${state.main.color}"]`).forEach(el => el.checked = true);
            document.querySelectorAll(`input[name="note-color"][value="${state.note.color}"]`).forEach(el => el.checked = true);
        }

        // --- EVENT HANDLING ---
        function setupEventListeners() {
            // Use event delegation for controls that exist in multiple places
            document.body.addEventListener('input', handleInput);
            document.body.addEventListener('change', handleInput);

            // Mobile panel controls
            const mobileToolBtns = document.querySelectorAll('.mobile-tool-btn');
            const panelsContainer = document.getElementById('panels-container');
            mobileToolBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const panelId = btn.dataset.panel;
                    const panel = document.getElementById(panelId);
                    const isOpen = panel.classList.contains('is-open');

                    closeAllPanels();
                    
                    if (!isOpen) {
                        panel.classList.add('is-open');
                        panelsContainer.style.visibility = 'visible';
                        btn.classList.add('active');
                    }
                });
            });
            panelsContainer.addEventListener('click', closeAllPanels);
            
            // Download button
            downloadBtn.addEventListener('click', () => {
                downloadBtn.href = canvas.toDataURL('image/png');
            });
        }
        
        function handleInput(e) {
            const target = e.target;
            const name = target.name;
            const value = target.value;

            if (target.id === 'text1') state.mainText = value;
            if (target.id === 'text3') state.noteText = value;
            if (name === 'layout') state.layout = value;
            if (name === 'main-font') state.main.font = value;
            if (name === 'note-font') state.note.font = value;
            if (name === 'main-color') state.main.color = value;
            if (name === 'note-color') state.note.color = value;
            
            redrawCanvas();
        }

        function closeAllPanels() {
            document.querySelectorAll('.mobile-panel.is-open').forEach(p => p.classList.remove('is-open'));
            document.querySelectorAll('.mobile-tool-btn.active').forEach(b => b.classList.remove('active'));
            document.getElementById('panels-container').style.visibility = 'hidden';
        }

        // --- DRAWING ENGINE ---
        function redrawCanvas() {
            if (!backgroundImage.complete || !areFontsLoaded) {
                // Don't draw if assets aren't ready, except for logo error case
                if(!isLogoLoaded && !logoImage.src.endsWith('logo.png')) return;
            }
            
            // 1. Clear and draw background
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            const currentLayout = layouts[state.layout];

            // 2. Draw Logo
            if (isLogoLoaded) {
                drawLogo(currentLayout.logo);
            }

            // 3. Draw Main Text
            if (state.mainText.trim()) {
                drawText(state.mainText, state.main, currentLayout.main);
            }

            // 4. Draw Note Text
            if (state.noteText.trim()) {
                drawText(state.noteText, state.note, currentLayout.note);
            }
        }
        
        function drawLogo(position) {
            const logoSize = canvas.width * (state.logo.size / 100);
            const margin = canvas.width * 0.04;
            
            const pos = getXY(position, margin, logoSize, logoSize);
            
            ctx.drawImage(logoImage, pos.x, pos.y, logoSize, logoSize);
        }

        function drawText(text, style, position) {
            const fontSize = canvas.width * (style.size / 1000);
            const margin = canvas.width * 0.04;
            const maxWidth = canvas.width - (margin * 2);
            
            ctx.font = `bold ${fontSize}px "${style.font}"`;
            ctx.fillStyle = style.color;
            
            // Text shadow for better readability
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            const lines = wrapText(ctx, text, maxWidth);
            const lineHeight = fontSize * 1.3;
            const textBlockHeight = lines.length * lineHeight;

            const pos = getXY(position, margin, maxWidth, textBlockHeight);

            ctx.textAlign = pos.textAlign;
            
            lines.forEach((line, index) => {
                ctx.fillText(line, pos.x, pos.y + (index * lineHeight));
            });
            
            // Reset shadow
            ctx.shadowColor = 'transparent';
        }

        function getXY(position, margin, blockWidth, blockHeight) {
            let x, y, textAlign;

            // Horizontal
            switch(position.h) {
                case 'left':
                    x = margin;
                    textAlign = 'left';
                    break;
                case 'right':
                    x = canvas.width - margin;
                    textAlign = 'right';
                    break;
                case 'center':
                default:
                    x = canvas.width / 2;
                    textAlign = 'center';
            }

            // Vertical
            switch(position.v) {
                case 'top':
                    y = margin;
                    break;
                case 'bottom':
                    y = canvas.height - margin - blockHeight;
                    break;
                case 'center':
                default:
                    y = (canvas.height / 2) - (blockHeight / 2);
            }
            
            // For text drawing, textBaseline is top
            if (position.v !== 'bottom') {
                 y += (ctx.measureText('M').width * 1.2); // approximation of line height
            }


            return { x, y, textAlign };
        }

        function wrapText(ctx, text, maxWidth) {
            const finalLines = [];
            const paragraphs = text.split('\n');
            paragraphs.forEach(p => {
                const words = p.split(' ');
                let currentLine = words[0] || '';
                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + " " + word;
                    if (ctx.measureText(testLine).width < maxWidth) {
                        currentLine = testLine;
                    } else {
                        finalLines.push(currentLine);
                        currentLine = word;
                    }
                }
                finalLines.push(currentLine);
            });
            return finalLines;
        }

        // --- START THE APP ---
        init();
    </script>
</body>
</html>
